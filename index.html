<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Gi√°m ƒë·ªëc C√¥ng Vi·ªác</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- JS Libraries for PDF, Excel, and DOCX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    
    <!-- Custom Styles & Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input[type="file"]::file-selector-button {
            @apply font-semibold bg-blue-50 text-blue-700 border-0 mr-4 px-4 py-2 rounded-md cursor-pointer hover:bg-blue-100 transition-colors;
        }
        .task-done p, .task-done em {
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
        }
        .kanban-column { min-height: 200px; }
        .dragging { opacity: 0.5; transform: rotate(2deg); }
        #suggestionModal.hidden { display: none; }
        
        .task-card {
            border-left-width: 4px;
            border-color: transparent;
        }
        .priority-high { border-left-color: #ef4444; } /* red-500 */
        .priority-medium { border-left-color: #f59e0b; } /* amber-500 */
        .priority-low { border-left-color: #22c55e; } /* green-500 */
        .task-pinned {
            background-color: #fef9c3; /* yellow-100 */
            box-shadow: 0 0 0 2px #facc15; /* yellow-400 */
        }
        .due-date { font-size: 0.75rem; font-weight: 500; }
        .due-date-passed { color: #dc2626; } /* red-600 */
        .due-date-today { color: #d97706; } /* amber-600 */

        #confettiCanvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">
    <canvas id="confettiCanvas"></canvas>

    <!-- Authentication Container -->
    <div id="authContainer" class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
        <div id="initialization-error" class="hidden"></div>
        <div id="auth-content">
            <h1 class="text-3xl font-bold text-slate-800 text-center mb-2">Ch√†o m·ª´ng b·∫°n</h1>
            <p class="text-center text-gray-500 mb-8">ƒêƒÉng nh·∫≠p ƒë·ªÉ AI qu·∫£n l√Ω c√¥ng vi·ªác cho b·∫°n</p>
            <input type="email" id="emailInput" placeholder="Email" class="w-full p-3 mb-4 bg-gray-50 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
            <input type="password" id="passwordInput" placeholder="M·∫≠t kh·∫©u" class="w-full p-3 mb-4 bg-gray-50 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
            <button id="loginButton" class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors">ƒêƒÉng nh·∫≠p</button>
            <button id="registerButton" class="w-full py-3 px-4 mt-2 bg-gray-600 text-white font-semibold rounded-md hover:bg-gray-700 transition-colors">ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi</button>
            <p id="authMessage" class="text-center font-medium mt-4 h-auto"></p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="w-full max-w-4xl bg-white p-8 rounded-xl shadow-lg" style="display: none;">
        <div id="userStatus" class="text-center mb-6 p-3 bg-gray-100 rounded-md flex justify-between items-center"></div>
        
        <div class="mb-10">
            <h1 class="text-3xl font-bold text-slate-800 mb-2">Giao vi·ªác cho AI</h1>
            <p class="text-gray-500 mb-6">Nh·∫≠p m·ªôt m·ª•c ti√™u l·ªõn, AI s·∫Ω t·ª± ƒë·ªông tham kh·∫£o c√°c t√†i li·ªáu g·∫ßn ƒë√¢y c·ªßa b·∫°n ƒë·ªÉ ƒë∆∞a ra k·∫ø ho·∫°ch t·ªët nh·∫•t.</p>
            <textarea id="promptInput" rows="4" placeholder="V√≠ d·ª•: L√™n k·∫ø ho·∫°ch ra m·∫Øt m·ªôt website portfolio trong 3 tu·∫ßn t·ªõi..." class="w-full p-3 bg-gray-50 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none transition"></textarea>
            <button id="sendPromptButton" class="w-full py-3 px-4 mt-4 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors">
                <span id="buttonText">L·∫≠p K·∫ø Ho·∫°ch Th√¥ng Minh</span>
            </button>
            <p id="statusMessage" class="text-center font-medium mt-4 h-5"></p>
        </div>
        
        <div class="border-t pt-8 mb-10">
            <h1 class="text-3xl font-bold text-slate-800 mb-2">X√¢y d·ª±ng C∆° s·ªü Tri th·ª©c</h1>
            <p class="text-gray-500 mb-6">T·∫£i l√™n file t√†i li·ªáu (.txt, .pdf, .docx, .xlsx, .xls) ƒë·ªÉ AI ƒë·ªçc, t√≥m t·∫Øt v√† ghi nh·ªõ.</p>
            <input type="file" id="fileInput" accept=".txt,.pdf,.xlsx,.xls,.docx" class="w-full text-sm text-slate-500 border border-gray-300 rounded-md cursor-pointer bg-gray-50 focus:outline-none">
            <button id="uploadButton" class="w-full py-3 px-4 mt-4 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition-colors">T√≥m t·∫Øt v√† L∆∞u tr·ªØ</button>
            <p id="uploadStatus" class="text-center font-medium mt-4 h-5"></p>
        </div>
        
        <div class="border-t pt-8 mb-10">
            <h1 class="text-3xl font-bold text-slate-800 mb-2">Tr·ª£ l√Ω Ph√¢n t√≠ch Hi·ªáu su·∫•t</h1>
            <p class="text-gray-500 mb-6">Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ AI xem l·∫°i c√°c c√¥ng vi·ªác trong 7 ng√†y qua v√† ƒë∆∞a ra nh·∫≠n x√©t, g·ª£i √Ω cho b·∫°n.</p>
            <button id="analyzeWeekButton" class="w-full py-3 px-4 mt-4 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 transition-colors">Ph√¢n t√≠ch Tu·∫ßn c·ªßa t√¥i</button>
            <div id="reviewContainer" class="mt-4 p-4 border border-gray-200 bg-gray-50 rounded-md min-h-[120px] text-gray-700 whitespace-pre-wrap flex items-center justify-center">Ch∆∞a c√≥ ph√¢n t√≠ch...</div>
        </div>
        
        <div class="border-t pt-8 mb-10">
            <h1 class="text-3xl font-bold text-slate-800 mb-2">Tr·ª£ l√Ω Ch·ªß ƒë·ªông</h1>
            <p class="text-gray-500 mb-6">B·∫°n ƒëang b·ªã k·∫πt ·ªü m·ªôt c√¥ng vi·ªác n√†o ƒë√≥? H√£y ƒë·ªÉ AI t√¨m v√† ƒë∆∞a ra g·ª£i √Ω gi√∫p b·∫°n kh∆°i th√¥ng √Ω t∆∞·ªüng.</p>
            <button id="findStuckTaskButton" class="w-full py-3 px-4 mt-4 bg-amber-500 text-white font-semibold rounded-md hover:bg-amber-600 transition-colors">T√¨m v√† g·ª° r·ªëi gi√∫p t√¥i!</button>
            <div id="stuckTaskContainer" class="mt-4 p-4 border-gray-200 bg-gray-50 rounded-md min-h-[120px] text-gray-700 whitespace-pre-wrap flex items-center justify-center">Ch∆∞a c√≥ g·ª£i √Ω...</div>
        </div>

        <div class="border-t pt-8 mb-10">
            <h1 class="text-3xl font-bold text-slate-800 mb-2">AI C·ªë v·∫•n Chi·∫øn l∆∞·ª£c</h1>
            <p class="text-gray-500 mb-6">ƒê·ªÉ AI ph√¢n t√≠ch to√†n b·ªô l·ªãch s·ª≠ c√¥ng vi·ªác v√† kho tri th·ª©c c·ªßa b·∫°n ƒë·ªÉ g·ª£i √Ω c√°c m·ª•c ti√™u l·ªõn (OKRs) cho qu√Ω t·ªõi.</p>
            <button id="strategicAdvisorButton" class="w-full py-3 px-4 mt-4 bg-red-600 text-white font-semibold rounded-md hover:bg-red-700 transition-colors">G·ª£i √Ω M·ª•c ti√™u Chi·∫øn l∆∞·ª£c</button>
            <div id="strategicReviewContainer" class="mt-4 p-4 border border-gray-200 bg-gray-50 rounded-md min-h-[120px] text-gray-700 whitespace-pre-wrap flex items-center justify-center">Ch∆∞a c√≥ ph√¢n t√≠ch...</div>
        </div>

        <div>
            <div class="flex items-center justify-between mb-4">
                 <h2 class="text-2xl font-bold text-slate-700">K·∫ø ho·∫°ch Hi·ªán t·∫°i</h2>
                 <div id="view-switcher" class="flex space-x-1 bg-gray-200 p-1 rounded-md">
                     <button data-view="checklist" class="px-3 py-1 text-sm font-semibold rounded-md bg-white text-blue-600 shadow">Checklist</button>
                     <button data-view="kanban" class="px-3 py-1 text-sm font-semibold rounded-md text-gray-600">Kanban</button>
                 </div>
            </div>
            <div id="responseContainer" class="mt-2 p-4 border border-gray-200 bg-gray-50 rounded-md min-h-[250px] text-gray-700 whitespace-pre-wrap flex items-center justify-center"></div>
        </div>
    </div>

    <!-- Suggestion Modal -->
    <div id="suggestionModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">G·ª£i √Ω t·ª´ AI</h3>
                <div id="modal-content" class="mt-2 px-7 py-3 max-h-96 overflow-y-auto"></div>
                <div class="items-center px-4 py-3">
                    <button id="closeModalButton" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        // --------------------------------------------------------------------
        // SECTION 1: IMPORTS
        // --------------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, doc, getDoc, updateDoc, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        import { getAI, getGenerativeModel } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-ai.js";

        // --------------------------------------------------------------------
        // SECTION 2: FIREBASE & LIBRARY CONFIGURATION
        // --------------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyC5IL0h_wC-ydk3H9S_lmvSwVsUTtPJE3s",
            authDomain: "aidirect-a4a8e.firebaseapp.com",
            projectId: "aidirect-a4a8e",
            storageBucket: "aidirect-a4a8e.firebasestorage.app",
            messagingSenderId: "113612483396",
            appId: "1:113612483396:web:4fd1bfe92c936ecd818511"
        };
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

        // --------------------------------------------------------------------
        // SECTION 3: DOM ELEMENT SELECTORS
        // --------------------------------------------------------------------
        const authContainer = document.getElementById('authContainer');
        const authContent = document.getElementById('auth-content');
        const initErrorContainer = document.getElementById('initialization-error');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginButton = document.getElementById('loginButton');
        const registerButton = document.getElementById('registerButton');
        const authMessage = document.getElementById('authMessage');
        const appContainer = document.getElementById('appContainer');
        const userStatus = document.getElementById('userStatus');
        const promptInput = document.getElementById('promptInput');
        const sendPromptButton = document.getElementById('sendPromptButton');
        const buttonText = document.getElementById('buttonText');
        const statusMessage = document.getElementById('statusMessage');
        const fileInput = document.getElementById('fileInput');
        const uploadButton = document.getElementById('uploadButton');
        const uploadStatus = document.getElementById('uploadStatus');
        const reviewContainer = document.getElementById('reviewContainer');
        const analyzeWeekButton = document.getElementById('analyzeWeekButton');
        const findStuckTaskButton = document.getElementById('findStuckTaskButton');
        const stuckTaskContainer = document.getElementById('stuckTaskContainer');
        const strategicAdvisorButton = document.getElementById('strategicAdvisorButton');
        const strategicReviewContainer = document.getElementById('strategicReviewContainer');
        const viewSwitcher = document.getElementById('view-switcher');
        const responseContainer = document.getElementById('responseContainer');
        const suggestionModal = document.getElementById('suggestionModal');
        const modalContent = document.getElementById('modal-content');
        const closeModalButton = document.getElementById('closeModalButton');
        const confettiCanvas = document.getElementById('confettiCanvas');

        // --------------------------------------------------------------------
        // SECTION 4: GLOBAL STATE & INITIALIZATION
        // --------------------------------------------------------------------
        let auth, db, aiModelJson, aiModelText, currentPlan = null, currentView = 'checklist';

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            const ai = getAI(app);
            aiModelJson = getGenerativeModel(ai, { model: "gemini-1.5-flash-latest", generationConfig: { responseMimeType: "application/json" } });
            aiModelText = getGenerativeModel(ai, { model: "gemini-1.5-flash-latest" });
            
            console.log("Firebase services initialized successfully.");
            setupApplicationLogic();
        } catch (error) {
            console.error("FIREBASE INITIALIZATION FAILED:", error);
            authContent.style.display = 'none';
            let errorHtml = `
                <div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-md text-left">
                    <p class="font-bold text-lg">L·ªói C·∫•u h√¨nh Firebase</p>
                    <p class="mt-2 text-sm">Kh√¥ng th·ªÉ kh·ªüi t·∫°o ·ª©ng d·ª•ng. L·ªói: ${error.message}</p>
                    ${error.message.includes('API key not valid') ? `
                    <p class="mt-2 text-sm">Vui l√≤ng ki·ªÉm tra l·∫°i <strong>firebaseConfig</strong> trong m√£ ngu·ªìn v√† ƒë·∫£m b·∫£o n√≥ ch√≠nh x√°c. B·∫°n c√≥ th·ªÉ l·∫•y l·∫°i t·ª´ C√†i ƒë·∫∑t d·ª± √°n trong Firebase Console.</p>
                    ` : ''}
                </div>`;
            initErrorContainer.innerHTML = errorHtml;
            initErrorContainer.classList.remove('hidden');
        }

        // --------------------------------------------------------------------
        // SECTION 5: APPLICATION LOGIC SETUP
        // --------------------------------------------------------------------
        function setupApplicationLogic() {
            // --- Helper Functions ---
            const showAuthMessage = (message, isError = true) => {
                authMessage.innerHTML = '';
                authMessage.textContent = message;
                authMessage.className = `text-center font-medium mt-4 h-auto ${isError ? 'text-red-600' : 'text-green-600'}`;
            };
            
            const renderChecklist = (planId, tasks) => {
                responseContainer.innerHTML = '';
                const taskList = document.createElement('ul');
                taskList.className = 'space-y-4 text-left w-full';
                taskList.dataset.planId = planId;
                
                tasks.sort((a, b) => (b.isPinned ? 1 : 0) - (a.isPinned ? 1 : 0) || (a.id && b.id ? a.id.localeCompare(b.id) : 0));

                tasks.forEach(task => {
                    const isDone = task.status === 'done';
                    const listItem = document.createElement('li');
                    listItem.className = `task-card p-4 bg-white border border-gray-200 rounded-lg shadow-sm transition-colors ${isDone ? 'task-done' : ''} ${task.isPinned ? 'task-pinned' : 'priority-' + (task.priority || 'medium')}`;
                    
                    let dueDateHTML = '';
                    if (task.dueDate) {
                        const today = new Date(); today.setHours(0,0,0,0);
                        const dueDate = new Date(task.dueDate + 'T00:00:00');
                        let dateClass = '';
                        if (dueDate < today) dateClass = 'due-date-passed';
                        else if (dueDate.getTime() === today.getTime()) dateClass = 'due-date-today';
                        dueDateHTML = `<span class="due-date ${dateClass}">H·∫°n: ${dueDate.toLocaleDateString('vi-VN')}</span>`;
                    }

                    listItem.innerHTML = `
                        <div class="flex items-start justify-between">
                            <div class="flex items-start">
                                <input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mt-1 mr-4 cursor-pointer" data-task-id="${task.id}" ${isDone ? 'checked' : ''}>
                                <div>
                                    <p class="font-semibold text-slate-800">${task.title}</p>
                                    <p class="text-sm text-gray-500 mt-1"><em>G·ª£i √Ω: ${task.suggestion}</em></p>
                                    ${dueDateHTML}
                                </div>
                            </div>
                            <div class="flex items-center">
                                <button class="ai-suggestion-btn p-1 ml-4 text-gray-400 hover:text-blue-600 transition-colors" data-task-title="${task.title}" title="Nh·ªù AI g·ª£i √Ω chi ti·∫øt">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                                </button>
                                <button class="pin-btn p-1 ml-2 text-gray-400 hover:text-amber-500 transition-colors" data-task-id="${task.id}" title="${task.isPinned ? 'B·ªè ghim' : 'Ghim c√¥ng vi·ªác'}">${task.isPinned ? 'üìå' : 'üìç'}</button>
                            </div>
                        </div>`;
                    taskList.appendChild(listItem);
                });
                responseContainer.appendChild(taskList);
            };

            const renderKanban = (planId, tasks) => {
                responseContainer.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full text-left">
                        <div class="bg-gray-100 p-4 rounded-lg"> <h3 class="font-bold text-lg mb-4 text-slate-700">C·∫ßn l√†m</h3> <ul class="kanban-column space-y-4" data-status="todo"></ul> </div>
                        <div class="bg-gray-100 p-4 rounded-lg"> <h3 class="font-bold text-lg mb-4 text-slate-700">ƒêang l√†m</h3> <ul class="kanban-column space-y-4" data-status="inprogress"></ul> </div>
                        <div class="bg-gray-100 p-4 rounded-lg"> <h3 class="font-bold text-lg mb-4 text-slate-700">ƒê√£ xong</h3> <ul class="kanban-column space-y-4" data-status="done"></ul> </div>
                    </div>`;
                responseContainer.dataset.planId = planId;
                
                tasks.sort((a, b) => (b.isPinned ? 1 : 0) - (a.isPinned ? 1 : 0) || (a.id && b.id ? a.id.localeCompare(b.id) : 0));

                tasks.forEach(task => {
                    const column = responseContainer.querySelector(`[data-status="${task.status}"]`);
                    if (column) {
                        const listItem = document.createElement('li');
                        listItem.className = `task-card p-4 bg-white rounded-lg shadow-sm cursor-grab active:cursor-grabbing ${task.status === 'done' ? 'task-done' : ''} ${task.isPinned ? 'task-pinned' : 'priority-' + (task.priority || 'medium')}`;
                        listItem.draggable = true;
                        listItem.dataset.taskId = task.id;
                        
                        let dueDateHTML = '';
                        if (task.dueDate) {
                            const today = new Date(); today.setHours(0,0,0,0);
                            const dueDate = new Date(task.dueDate + 'T00:00:00');
                            let dateClass = '';
                            if (dueDate < today) dateClass = 'due-date-passed';
                            else if (dueDate.getTime() === today.getTime()) dateClass = 'due-date-today';
                            dueDateHTML = `<span class="due-date ${dateClass}">H·∫°n: ${dueDate.toLocaleDateString('vi-VN')}</span>`;
                        }

                        let moveButtonsHTML = '';
                        if (task.status === 'todo') { moveButtonsHTML = `<button class="move-task-btn p-1 text-gray-500 hover:text-blue-600" data-task-id="${task.id}" data-target-status="inprogress" title="B·∫Øt ƒë·∫ßu l√†m"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg></button>`;
                        } else if (task.status === 'inprogress') { moveButtonsHTML = `<button class="move-task-btn p-1 text-gray-500 hover:text-red-600" data-task-id="${task.id}" data-target-status="todo" title="Quay l·∫°i C·∫ßn l√†m"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L9.414 11H13a1 1 0 100-2H9.414l1.293-1.293z" clip-rule="evenodd" /></svg></button><button class="move-task-btn p-1 text-gray-500 hover:text-green-600" data-task-id="${task.id}" data-target-status="done" title="Ho√†n th√†nh"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></button>`;
                        } else { moveButtonsHTML = `<button class="move-task-btn p-1 text-gray-500 hover:text-amber-600" data-task-id="${task.id}" data-target-status="inprogress" title="L√†m l·∫°i"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 17H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg></button>`;}

                        listItem.innerHTML = `
                            <div class="flex justify-between items-start">
                                <p class="font-semibold text-slate-800">${task.title}</p>
                                <button class="pin-btn p-1 text-gray-400 hover:text-amber-500 transition-colors" data-task-id="${task.id}" title="${task.isPinned ? 'B·ªè ghim' : 'Ghim c√¥ng vi·ªác'}">${task.isPinned ? 'üìå' : 'üìç'}</button>
                            </div>
                            <p class="text-sm text-gray-500 mt-1"><em>${task.suggestion}</em></p>
                            ${dueDateHTML}
                            <div class="flex items-center justify-between w-full mt-2 pt-2 border-t border-gray-100">
                                <button class="ai-suggestion-btn p-1 text-gray-400 hover:text-blue-600 transition-colors" data-task-title="${task.title}" title="Nh·ªù AI g·ª£i √Ω chi ti·∫øt">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"></path></svg>
                                </button>
                                <div class="flex items-center space-x-1">${moveButtonsHTML}</div>
                            </div>`;
                        column.appendChild(listItem);
                    }
                });
            };

            const renderPlan = () => {
                if (!currentPlan) {
                    responseContainer.innerHTML = '<p>B·∫°n ch∆∞a c√≥ k·∫ø ho·∫°ch n√†o. H√£y t·∫°o m·ªôt c√°i m·ªõi!</p>'; return;
                }
                if (currentView === 'checklist') { renderChecklist(currentPlan.id, currentPlan.tasks); } 
                else { renderKanban(currentPlan.id, currentPlan.tasks); }
            };

            const loadLatestPlan = async (userId) => {
                responseContainer.innerHTML = '<p>ƒêang t·∫£i k·∫ø ho·∫°ch g·∫ßn nh·∫•t...</p>';
                try {
                    const q = query(collection(db, "plans"), where("userId", "==", userId));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        const plans = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        plans.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                        currentPlan = plans[0];
                        renderPlan();
                    } else {
                        currentPlan = null;
                        renderPlan();
                    }
                } catch (error) { 
                    console.error("Error loading plan:", error); 
                    responseContainer.innerHTML = '<p class="text-red-600">Kh√¥ng th·ªÉ t·∫£i k·∫ø ho·∫°ch.</p>'; 
                }
            };
            
            const updateTaskStatus = async (planId, taskId, newStatus) => {
                try {
                    const planRef = doc(db, "plans", planId);
                    const updatedTasks = currentPlan.tasks.map(task => {
                        if (task.id === taskId) {
                            const statusUpdateData = { ...task, status: newStatus };
                            if (newStatus === 'inprogress' && task.status !== 'inprogress') {
                                statusUpdateData.statusUpdatedAt = Timestamp.now();
                            }
                            return statusUpdateData;
                        }
                        return task;
                    });
                    await updateDoc(planRef, { tasks: updatedTasks });
                    currentPlan.tasks = updatedTasks;
                    if (newStatus === 'done') triggerConfetti();
                    console.log(`Task ${taskId} status updated to ${newStatus}`);
                    renderPlan();
                } catch (error) {
                    console.error("Error updating task status:", error);
                    alert("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i c√¥ng vi·ªác.");
                    renderPlan();
                }
            };

            const togglePinStatus = async (planId, taskId) => {
                try {
                    const planRef = doc(db, "plans", planId);
                    const taskToUpdate = currentPlan.tasks.find(t => t.id === taskId);
                    const newPinStatus = !taskToUpdate.isPinned;
                    const updatedTasks = currentPlan.tasks.map(task => 
                        task.id === taskId ? { ...task, isPinned: newPinStatus } : task
                    );
                    await updateDoc(planRef, { tasks: updatedTasks });
                    currentPlan.tasks = updatedTasks;
                    renderPlan();
                } catch (error) {
                    console.error("Error toggling pin status:", error);
                    alert("Kh√¥ng th·ªÉ ghim c√¥ng vi·ªác.");
                }
            };

            // --- Event Listeners ---
            onAuthStateChanged(auth, user => {
                if (user) {
                    authContainer.style.display = 'none'; 
                    appContainer.style.display = 'block';
                    userStatus.innerHTML = `<span class="text-gray-700">Xin ch√†o, <strong class="font-semibold text-slate-800">${user.email}</strong></span><button id="logoutButton" class="py-1 px-3 text-sm bg-red-600 text-white font-semibold rounded-md hover:bg-red-700 transition-colors">ƒêƒÉng xu·∫•t</button>`;
                    document.getElementById('logoutButton').addEventListener('click', () => signOut(auth));
                    loadLatestPlan(user.uid);
                } else {
                    authContainer.style.display = 'block'; 
                    appContainer.style.display = 'none';
                }
            });

            registerButton.addEventListener('click', async () => {
                showAuthMessage(''); 
                try { 
                    await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value); 
                    showAuthMessage("ƒêƒÉng k√Ω th√†nh c√¥ng!", false); 
                } catch (error) { 
                    showAuthMessage(`L·ªói: ${error.code}`); 
                }
            });

            loginButton.addEventListener('click', async () => {
                showAuthMessage(''); 
                try { 
                    await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value); 
                } catch (error) { 
                    showAuthMessage(`L·ªói: ${error.code}`); 
                }
            });
            
            sendPromptButton.addEventListener("click", async () => {
                const user = auth.currentUser; if (!user) return;
                const userGoal = promptInput.value.trim(); if (!userGoal) { statusMessage.textContent = "Vui l√≤ng nh·∫≠p m·ª•c ti√™u."; return; }
                statusMessage.textContent = "AI ƒëang t√¨m t√†i li·ªáu v√† suy nghƒ©..."; sendPromptButton.disabled = true; buttonText.textContent = "ƒêang x·ª≠ l√Ω..."; responseContainer.innerHTML = '<div class="spinner"></div>';
                try {
                    let contextText = "Kh√¥ng c√≥ ng·ªØ c·∫£nh b·ªï sung.";
                    try {
                        const knowledgeQuery = query(collection(db, "knowledge_base"), where("userId", "==", user.uid), orderBy("createdAt", "desc"), limit(5));
                        const knowledgeSnapshot = await getDocs(knowledgeQuery);
                        if (!knowledgeSnapshot.empty) {
                            const summaries = knowledgeSnapshot.docs.map(doc => `- (T·ª´ file ${doc.data().fileName}): ${doc.data().summary.replace(/\n/g, ' ')}`).join('\n');
                            contextText = `ƒê√¢y l√† m·ªôt v√†i th√¥ng tin ng·ªØ c·∫£nh t·ª´ c√°c t√†i li·ªáu g·∫ßn ƒë√¢y c·ªßa ng∆∞·ªùi d√πng ƒë·ªÉ b·∫°n tham kh·∫£o:\n${summaries}`;
                        }
                    } catch (e) { console.warn("Could not retrieve knowledge base context:", e); }

                    const finalPrompt = `B·∫°n l√† m·ªôt chuy√™n gia qu·∫£n l√Ω d·ª± √°n xu·∫•t s·∫Øc. H√£y ph√¢n r√£ m·ª•c ti√™u sau c·ªßa ng∆∞·ªùi d√πng th√†nh m·ªôt ƒë·ªëi t∆∞·ª£ng JSON: "${userGoal}".\n\n${contextText}\n\nD·ª±a v√†o m·ª•c ti√™u v√† ng·ªØ c·∫£nh tr√™n (n·∫øu c√≥), h√£y t·∫°o ra m·ªôt k·∫ø ho·∫°ch chi ti·∫øt. ƒê·ªëi t∆∞·ª£ng JSON ph·∫£i c√≥ m·ªôt kh√≥a duy nh·∫•t l√† "tasks". Gi√° tr·ªã c·ªßa "tasks" l√† m·ªôt m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng. M·ªói ƒë·ªëi t∆∞·ª£ng ph·∫£i c√≥ b·ªën thu·ªôc t√≠nh: 1. "title" (string), 2. "suggestion" (string), 3. "priority" (string, m·ªôt trong ba gi√° tr·ªã: 'high', 'medium', ho·∫∑c 'low'), v√† 4. "dueDate" (string, ƒë·ªãnh d·∫°ng YYYY-MM-DD, l√† m·ªôt ng√†y h·∫øt h·∫°n h·ª£p l√Ω trong t∆∞∆°ng lai; n·∫øu kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c, tr·∫£ v·ªÅ null). To√†n b·ªô n·ªôi dung ph·∫£i b·∫±ng ti·∫øng Vi·ªát.`;
                    
                    const result = await aiModelJson.generateContent(finalPrompt);
                    const tasksFromAI = JSON.parse(result.response.text()).tasks;
                    const tasksWithDetails = tasksFromAI.map(task => ({ ...task, id: crypto.randomUUID(), status: 'todo', isPinned: false }));
                    
                    const docRef = await addDoc(collection(db, "plans"), { userId: user.uid, goal: userGoal, tasks: tasksWithDetails, createdAt: serverTimestamp() });
                    currentPlan = { id: docRef.id, tasks: tasksWithDetails, createdAt: Timestamp.now(), goal: userGoal };
                    renderPlan(); 
                    statusMessage.textContent = "AI ƒë√£ l·∫≠p k·∫ø ho·∫°ch d·ª±a tr√™n ng·ªØ c·∫£nh th√†nh c√¥ng!";
                } catch (error) { 
                    console.error("AI Planning Error:", error); 
                    statusMessage.textContent = "L·ªói khi t·∫°o k·∫ø ho·∫°ch."; 
                    responseContainer.innerHTML = `<p class="text-red-600">ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i.</p>`; 
                } finally { 
                    sendPromptButton.disabled = false; 
                    buttonText.textContent = "L·∫≠p K·∫ø Ho·∫°ch Th√¥ng Minh"; 
                }
            });

            uploadButton.addEventListener('click', async () => {
                const user = auth.currentUser; const file = fileInput.files[0];
                if (!user || !file) { uploadStatus.textContent = !user ? "B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p." : "Vui l√≤ng ch·ªçn file."; return; }
                uploadButton.disabled = true; uploadStatus.textContent = `ƒêang x·ª≠ l√Ω file: ${file.name}...`;
                try {
                    let fileContent = ''; const fileExtension = file.name.split('.').pop().toLowerCase();
                    switch(fileExtension) {
                        case 'txt': fileContent = await file.text(); break;
                        case 'pdf': fileContent = await extractTextFromPdf(file); break;
                        case 'xlsx': case 'xls': fileContent = await extractTextFromExcel(file); break;
                        case 'docx': fileContent = await extractTextFromDocx(file); break;
                        default: throw new Error('ƒê·ªãnh d·∫°ng file kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£.');
                    }
                    uploadStatus.textContent = "ƒê√£ tr√≠ch xu·∫•t n·ªôi dung, ƒëang g·ª≠i cho AI...";
                    const summaryPrompt = `T√≥m t·∫Øt t√†i li·ªáu sau th√†nh m·ªôt v√†i g·∫°ch ƒë·∫ßu d√≤ng ch√≠nh. To√†n b·ªô n·ªôi dung t√≥m t·∫Øt ph·∫£i b·∫±ng ti·∫øng Vi·ªát. N·ªôi dung t√†i li·ªáu: "${fileContent}"`;
                    const result = await aiModelText.generateContent(summaryPrompt);
                    const summary = result.response.text();
                    await addDoc(collection(db, "knowledge_base"), { userId: user.uid, fileName: file.name, summary: summary, createdAt: serverTimestamp() });
                    uploadStatus.textContent = `ƒê√£ l∆∞u t√≥m t·∫Øt cho file: ${file.name}`; fileInput.value = '';
                } catch (error) { console.error("File Processing Error:", error); uploadStatus.textContent = `L·ªói: ${error.message}`; } 
                finally { uploadButton.disabled = false; }
            });
            
            viewSwitcher.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button || !currentPlan) return;
                currentView = button.dataset.view;
                viewSwitcher.querySelectorAll('button').forEach(btn => {
                    btn.classList.remove('bg-white', 'text-blue-600', 'shadow'); btn.classList.add('text-gray-600');
                });
                button.classList.add('bg-white', 'text-blue-600', 'shadow'); button.classList.remove('text-gray-600');
                renderPlan();
            });

            responseContainer.addEventListener('click', async (event) => {
                const suggestionBtn = event.target.closest('.ai-suggestion-btn');
                if (suggestionBtn) {
                    const taskTitle = suggestionBtn.dataset.taskTitle;
                    modalContent.innerHTML = '<div class="spinner mx-auto"></div>';
                    suggestionModal.classList.remove('hidden');
                    try {
                        const suggestionPrompt = `B·∫°n l√† m·ªôt tr·ª£ l√Ω c√¥ng vi·ªác chuy√™n nghi·ªáp. H√£y ƒë∆∞a ra c√°c b∆∞·ªõc chi ti·∫øt, kh·∫£ thi ƒë·ªÉ th·ª±c hi·ªán c√¥ng vi·ªác sau: "${taskTitle}". Tr√¨nh b√†y d∆∞·ªõi d·∫°ng c√°c g·∫°ch ƒë·∫ßu d√≤ng, s·ª≠ d·ª•ng ng√¥n ng·ªØ ti·∫øng Vi·ªát.`;
                        const result = await aiModelText.generateContent(suggestionPrompt);
                        modalContent.innerHTML = `<div class="text-left whitespace-pre-line">${result.response.text()}</div>`;
                    } catch (error) { console.error("Suggestion error:", error); modalContent.textContent = "L·ªói khi l·∫•y g·ª£i √Ω t·ª´ AI."; }
                }

                const moveBtn = event.target.closest('.move-task-btn');
                if (moveBtn) {
                    const taskId = moveBtn.dataset.taskId;
                    const targetStatus = moveBtn.dataset.targetStatus;
                    await updateTaskStatus(currentPlan.id, taskId, targetStatus);
                }

                const pinBtn = event.target.closest('.pin-btn');
                if (pinBtn) {
                    const taskId = pinBtn.dataset.taskId;
                    await togglePinStatus(currentPlan.id, taskId);
                }
            });

            responseContainer.addEventListener('change', async (event) => {
                if (event.target.matches('input[type="checkbox"]')) {
                    const taskId = event.target.dataset.taskId;
                    const planId = currentPlan.id;
                    const newStatus = event.target.checked ? 'done' : 'todo';
                    event.target.closest('li').classList.toggle('task-done', event.target.checked);
                    await updateTaskStatus(planId, taskId, newStatus);
                }
            });
            
            let draggedItem = null;
            responseContainer.addEventListener('dragstart', (e) => {
                if(e.target.matches('li[draggable="true"]')) {
                    draggedItem = e.target;
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                }
            });
            responseContainer.addEventListener('dragend', (e) => {
                if (draggedItem) { draggedItem.classList.remove('dragging'); draggedItem = null; }
            });
            responseContainer.addEventListener('dragover', (e) => { e.preventDefault(); });
            responseContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                const column = e.target.closest('.kanban-column');
                if (column && draggedItem) {
                    const newStatus = column.dataset.status;
                    const taskId = draggedItem.dataset.taskId;
                    const oldStatus = currentPlan.tasks.find(t=>t.id===taskId)?.status
                    if (newStatus !== oldStatus) {
                        column.appendChild(draggedItem);
                        updateTaskStatus(currentPlan.id, taskId, newStatus);
                    }
                }
            });

            analyzeWeekButton.addEventListener('click', async () => {
                const user = auth.currentUser; if (!user) { reviewContainer.textContent = "Vui l√≤ng ƒëƒÉng nh·∫≠p."; return; }
                reviewContainer.innerHTML = '<div class="spinner"></div>';
                analyzeWeekButton.disabled = true;
                try {
                    const sevenDaysAgo = new Date(); sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    const q = query(collection(db, "plans"), where("userId", "==", user.uid));
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty) { reviewContainer.textContent = "Kh√¥ng t√¨m th·∫•y ho·∫°t ƒë·ªông n√†o."; analyzeWeekButton.disabled = false; return; }
                    const recentDocs = querySnapshot.docs.filter(doc => doc.data().createdAt && doc.data().createdAt.toDate() >= sevenDaysAgo);
                    if (recentDocs.length === 0) { reviewContainer.textContent = "Kh√¥ng t√¨m th·∫•y ho·∫°t ƒë·ªông n√†o trong 7 ng√†y qua."; analyzeWeekButton.disabled = false; return; }
                    let completedTasks = [], pendingTasks = [];
                    recentDocs.forEach(doc => { const tasks = doc.data().tasks || []; tasks.forEach(task => { (task.status === 'done' ? completedTasks : pendingTasks).push(task.title); }); });
                    if (completedTasks.length === 0 && pendingTasks.length === 0) { reviewContainer.textContent = "B·∫°n ch∆∞a c√≥ c√¥ng vi·ªác n√†o trong tu·∫ßn qua."; analyzeWeekButton.disabled = false; return; }
                    const analysisPrompt = `B·∫°n l√† m·ªôt tr·ª£ l√Ω hi·ªáu su·∫•t th·∫•u c·∫£m... (prompt is the same)`;
                    const result = await aiModelText.generateContent(analysisPrompt);
                    reviewContainer.textContent = result.response.text();
                } catch (error) { console.error("Analysis Error:", error); reviewContainer.textContent = "R·∫•t ti·∫øc, ƒë√£ c√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh ph√¢n t√≠ch."; } 
                finally { analyzeWeekButton.disabled = false; }
            });

            findStuckTaskButton.addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user) { stuckTaskContainer.textContent = "Vui l√≤ng ƒëƒÉng nh·∫≠p."; return; }
                if (!currentPlan) { stuckTaskContainer.textContent = "Kh√¥ng c√≥ k·∫ø ho·∫°ch n√†o ƒëang ƒë∆∞·ª£c hi·ªÉn th·ªã."; return; }
                stuckTaskContainer.innerHTML = '<div class="spinner"></div>';
                findStuckTaskButton.disabled = true;
                try {
                    const inProgressTasks = currentPlan.tasks
                        .filter(task => task.status === 'inprogress' && task.statusUpdatedAt)
                        .sort((a, b) => (a.statusUpdatedAt?.toMillis() || 0) - (b.statusUpdatedAt?.toMillis() || 0));
                    const stuckTask = inProgressTasks.length > 0 ? inProgressTasks[0] : null;
                    if (!stuckTask) { stuckTaskContainer.textContent = "Tuy·ªát v·ªùi! Kh√¥ng c√≥ c√¥ng vi·ªác n√†o ƒëang b·ªã tr√¨ ho√£n trong c·ªôt 'ƒêang l√†m'."; return; }
                    const coachingPrompt = `B·∫°n l√† m·ªôt chuy√™n gia g·ª° r·ªëi c√¥ng vi·ªác... (prompt is the same)`;
                    const result = await aiModelText.generateContent(coachingPrompt);
                    stuckTaskContainer.innerHTML = `<div class="text-left w-full">... (display logic is the same) ...</div>`;
                } catch (error) { console.error("Stuck Task Analysis Error:", error); stuckTaskContainer.textContent = "R·∫•t ti·∫øc, ƒë√£ c√≥ l·ªói x·∫£y ra."; } 
                finally { findStuckTaskButton.disabled = false; }
            });
            
            strategicAdvisorButton.addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user) { strategicReviewContainer.textContent = "Vui l√≤ng ƒëƒÉng nh·∫≠p."; return; }
                strategicReviewContainer.innerHTML = '<div class="spinner"></div>';
                strategicAdvisorButton.disabled = true;
                try {
                    let historyText = ""; let knowledgeText = "";
                    const plansQuery = query(collection(db, "plans"), where("userId", "==", user.uid));
                    const plansSnapshot = await getDocs(plansQuery);
                    if (!plansSnapshot.empty) { /* ... */ } else { historyText = "L·ªäCH S·ª¨ K·∫æ HO·∫†CH V√Ä C√îNG VI·ªÜC: Ch∆∞a c√≥ d·ªØ li·ªáu."; }
                    const knowledgeQuery = query(collection(db, "knowledge_base"), where("userId", "==", user.uid));
                    const knowledgeSnapshot = await getDocs(knowledgeQuery);
                    if (!knowledgeSnapshot.empty) { /* ... */ } else { knowledgeText = "KHO TRI TH·ª®C (T√ìM T·∫ÆT T√ÄI LI·ªÜU): Ch∆∞a c√≥ d·ªØ li·ªáu."; }
                    const strategicPrompt = `B·∫°n l√† m·ªôt nh√† c·ªë v·∫•n chi·∫øn l∆∞·ª£c... (prompt is the same)`;
                    const result = await aiModelText.generateContent(strategicPrompt);
                    strategicReviewContainer.innerHTML = `<div class="text-left whitespace-pre-line">${result.response.text()}</div>`;
                } catch (error) { console.error("Strategic Analysis Error:", error); strategicReviewContainer.textContent = "R·∫•t ti·∫øc, ƒë√£ c√≥ l·ªói x·∫£y ra."; } 
                finally { strategicAdvisorButton.disabled = false; }
            });

            closeModalButton.addEventListener('click', () => { suggestionModal.classList.add('hidden'); });
            window.addEventListener('click', (event) => { if (event.target == suggestionModal) { suggestionModal.classList.add('hidden'); } });
            
            // --- File Processing Helpers ---
            async function extractTextFromPdf(file) { /* ... */ }
            async function extractTextFromExcel(file) { /* ... */ }
            async function extractTextFromDocx(file) { /* ... */ }
        }
    </script>
</body>
</html>
